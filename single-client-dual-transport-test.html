<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>å• WebMcpClient åŒ Transport éªŒè¯æµ‹è¯•</title>
    <script src="https://unpkg.com/@opentiny/next-sdk@0.1.10/dist/index.umd.js"></script>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #ff9800;
        padding-bottom: 10px;
      }
      .warning {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 4px;
        padding: 15px;
        margin: 20px 0;
        color: #856404;
      }
      .panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
      }
      .panel h2 {
        margin-top: 0;
        color: #555;
        font-size: 18px;
      }
      button {
        background: #ff9800;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px;
        transition: background 0.3s;
      }
      button:hover {
        background: #f57c00;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .log {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin-top: 15px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }
      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid #4caf50;
        padding-left: 10px;
      }
      .log-entry.error {
        border-left-color: #f44336;
        color: #f44336;
      }
      .log-entry.success {
        border-left-color: #4caf50;
        color: #4caf50;
      }
      .log-entry.info {
        border-left-color: #2196f3;
        color: #2196f3;
      }
      .log-entry.warning {
        border-left-color: #ff9800;
        color: #ff9800;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 4px;
        font-weight: bold;
      }
      .result.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .result.failure {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      iframe {
        width: 100%;
        height: 150px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§ª å• WebMcpClient åŒ Transport éªŒè¯æµ‹è¯•</h1>

    <div class="warning">
      <strong>âš ï¸ å®éªŒæ€§æµ‹è¯•</strong><br />
      æœ¬æµ‹è¯•éªŒè¯ä¸€ä¸ª MCP WebMcpClient å®ä¾‹èƒ½å¦åŒæ—¶è¿æ¥ä¸¤ä¸ªä¸åŒçš„ Transportã€‚<br />
      æ ¹æ® MCP åè®®è®¾è®¡ï¼Œè¿™é€šå¸¸æ˜¯ä¸æ”¯æŒçš„ï¼Œä½†æˆ‘ä»¬é€šè¿‡å®éªŒæ¥éªŒè¯ã€‚
    </div>

    <div class="panel">
      <h2>ğŸ”¬ æµ‹è¯•åœºæ™¯</h2>
      <p>å°è¯•è®©ä¸€ä¸ª WebMcpClient å®ä¾‹ï¼š</p>
      <ol>
        <li>å…ˆè¿æ¥åˆ° Server A (iframe - MessageChannel)</li>
        <li>å†è¿æ¥åˆ° Server B (æœ¬åœ° - TransportPair)</li>
        <li>éªŒè¯ä¸¤ä¸ªè¿æ¥æ˜¯å¦éƒ½æœ‰æ•ˆ</li>
        <li>å°è¯•è°ƒç”¨ä¸¤ä¸ª Server çš„å·¥å…·</li>
      </ol>

      <button id="btnRunTest">è¿è¡Œæµ‹è¯•</button>
      <button id="btnClearLog">æ¸…ç©ºæ—¥å¿—</button>

      <div class="log" id="log"></div>

      <div id="result"></div>

      <iframe id="iframeServer" style="display: none"></iframe>
    </div>

    <script type="module">
      import { MessageChannelClientTransport } from 'https://cdn.jsdelivr.net/npm/@opentiny/next@0.2.1/+esm';

      const { createMessageChannelPairTransport, WebMcpServer, WebMcpClient, z } = WebMCP;

      let singleClient = null;
      let serverA = null;
      let serverB = null;

      // æ—¥å¿—å·¥å…·
      function log(message, type = 'info') {
        const container = document.getElementById('log');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        container.appendChild(entry);
        container.scrollTop = container.scrollHeight;
        console.log(`[${type}]`, message);
      }

      function showResult(success, message) {
        const resultDiv = document.getElementById('result');
        resultDiv.className = `result ${success ? 'success' : 'failure'}`;
        resultDiv.textContent = message;
      }

      // åˆå§‹åŒ– Server A (iframe)
      async function initServerA() {
        log('=== åˆå§‹åŒ– Server A (iframe) ===', 'info');

        const iframe = document.getElementById('iframeServer');
        iframe.src = 'dual-transport-server-a.html';

        await new Promise((resolve, reject) => {
          iframe.onload = resolve;
          iframe.onerror = reject;
          setTimeout(() => reject(new Error('iframe åŠ è½½è¶…æ—¶')), 5000);
        });

        log('iframe å·²åŠ è½½', 'success');

        window.addEventListener('message', function handler(event) {
          if (event.data.type === 'server-a-ready') {
            window.removeEventListener('message', handler);
          }
        });

        log('Server A å·²å‡†å¤‡å°±ç»ª', 'success');
        return iframe;
      }

      // åˆå§‹åŒ– Server B (æœ¬åœ°)
      async function initServerB() {
        log('=== åˆå§‹åŒ– Server B (æœ¬åœ°) ===', 'info');

        const [serverTransport, clientTransport] = createMessageChannelPairTransport();

        serverB = new WebMcpServer({
          name: 'local-server-b',
          version: '1.0.0'
        });

        serverB.registerTool(
          'calculate',
          {
            title: 'è®¡ç®—å™¨',
            description: 'æ‰§è¡ŒåŸºæœ¬æ•°å­¦è¿ç®—',
            inputSchema: {
              operation: z.enum(['add', 'subtract', 'multiply', 'divide']),
              a: z.number(),
              b: z.number()
            }
          },
          async ({ operation, a, b }) => {
            let result;
            switch (operation) {
              case 'add':
                result = a + b;
                break;
              case 'subtract':
                result = a - b;
                break;
              case 'multiply':
                result = a * b;
                break;
              case 'divide':
                result = b !== 0 ? a / b : 'Error: Division by zero';
                break;
            }
            return {
              content: [{ type: 'text', text: `ç»“æœ: ${result}` }]
            };
          }
        );

        await serverB.connect(serverTransport);
        log('Server B å·²å¯åŠ¨', 'success');

        return clientTransport;
      }

      // è¿è¡Œæµ‹è¯•
      async function runTest() {
        try {
          document.getElementById('result').innerHTML = '';
          log('', 'info');
          log('ğŸš€ å¼€å§‹æµ‹è¯•ï¼šä¸€ä¸ª WebMcpClient è¿æ¥ä¸¤ä¸ª Transport', 'info');
          log('', 'info');

          // æ­¥éª¤ 1: åˆå§‹åŒ–ä¸¤ä¸ª Server
          log('æ­¥éª¤ 1: åˆå§‹åŒ–ä¸¤ä¸ª Server', 'info');
          const iframe = await initServerA();
          const clientTransportB = await initServerB();
          log('âœ… ä¸¤ä¸ª Server éƒ½å·²å‡†å¤‡å°±ç»ª', 'success');
          log('', 'info');

          // æ­¥éª¤ 2: åˆ›å»ºå•ä¸ª WebMcpClient
          log('æ­¥éª¤ 2: åˆ›å»ºå•ä¸ª WebMcpClient å®ä¾‹', 'info');
          const capabilities = { prompts: {}, resources: {}, tools: {}, logging: {} };
          singleClient = new WebMcpClient({ name: 'single-test-client', version: '1.0.0' }, { capabilities });
          log('âœ… WebMcpClient å®ä¾‹å·²åˆ›å»º', 'success');
          log('', 'info');

          // æ­¥éª¤ 3: ç¬¬ä¸€æ¬¡è¿æ¥ - è¿æ¥åˆ° Server A
          log('æ­¥éª¤ 3: å°è¯•è¿æ¥åˆ° Server A (iframe)', 'info');
          const clientTransportA = new MessageChannelClientTransport('server-a-endpoint', iframe.contentWindow);

          await singleClient.connect(clientTransportA);
          log('âœ… æˆåŠŸè¿æ¥åˆ° Server A', 'success');

          // éªŒè¯è¿æ¥ A
          const toolsA = await singleClient.listTools();
          log(`å‘ç° Server A çš„å·¥å…·: ${toolsA.tools.map((t) => t.name).join(', ')}`, 'info');
          log('', 'info');

          // æ­¥éª¤ 4: ç¬¬äºŒæ¬¡è¿æ¥ - å°è¯•è¿æ¥åˆ° Server B
          log('æ­¥éª¤ 4: å°è¯•è¿æ¥åˆ° Server B (æœ¬åœ°)', 'warning');
          log('âš ï¸  æ³¨æ„ï¼šClient å·²ç»è¿æ¥åˆ° Server A', 'warning');

          try {
            await singleClient.connect(clientTransportB);
            log('âœ… æˆåŠŸè¿æ¥åˆ° Server B', 'success');

            // éªŒè¯è¿æ¥ B
            const toolsB = await singleClient.listTools();
            log(`å½“å‰å¯ç”¨å·¥å…·: ${toolsB.tools.map((t) => t.name).join(', ')}`, 'info');
            log('', 'info');

            // æ­¥éª¤ 5: æµ‹è¯•å·¥å…·è°ƒç”¨
            log('æ­¥éª¤ 5: æµ‹è¯•å·¥å…·è°ƒç”¨', 'info');

            // å°è¯•è°ƒç”¨ Server A çš„å·¥å…·
            log('å°è¯•è°ƒç”¨ Server A çš„å·¥å…· (generate-greeting)...', 'info');
            try {
              const resultA = await singleClient.callTool({
                name: 'generate-greeting',
                arguments: { name: 'æµ‹è¯•', language: 'zh' }
              });
              log(`âœ… Server A å·¥å…·è°ƒç”¨æˆåŠŸ: ${resultA.content[0].text}`, 'success');
            } catch (error) {
              log(`âŒ Server A å·¥å…·è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
            }

            // å°è¯•è°ƒç”¨ Server B çš„å·¥å…·
            log('å°è¯•è°ƒç”¨ Server B çš„å·¥å…· (calculate)...', 'info');
            try {
              const resultB = await singleClient.callTool({
                name: 'calculate',
                arguments: { operation: 'add', a: 10, b: 20 }
              });
              log(`âœ… Server B å·¥å…·è°ƒç”¨æˆåŠŸ: ${resultB.content[0].text}`, 'success');
            } catch (error) {
              log(`âŒ Server B å·¥å…·è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
            }

            log('', 'info');
            log('ğŸ‰ æµ‹è¯•ç»“è®ºï¼šä¸€ä¸ª WebMcpClient å¯ä»¥è¿æ¥ä¸¤ä¸ª Transportï¼', 'success');
            log('ä½†æ˜¯ç¬¬äºŒæ¬¡è¿æ¥ä¼šè¦†ç›–ç¬¬ä¸€æ¬¡è¿æ¥ï¼Œåªèƒ½è®¿é—®æœ€åè¿æ¥çš„ Server', 'warning');
            showResult(true, 'âœ… æµ‹è¯•å®Œæˆï¼šClient å¯ä»¥è¿æ¥å¤šä¸ª Transportï¼Œä½†åªä¿æŒæœ€åä¸€ä¸ªè¿æ¥æœ‰æ•ˆ');
          } catch (error) {
            log(`âŒ è¿æ¥åˆ° Server B å¤±è´¥: ${error.message}`, 'error');
            log('', 'info');
            log('ğŸ” æµ‹è¯•ç»“è®ºï¼šä¸€ä¸ª WebMcpClient ä¸èƒ½åŒæ—¶è¿æ¥ä¸¤ä¸ª Transport', 'error');
            log('ç¬¬äºŒæ¬¡ connect() è°ƒç”¨å¤±è´¥ï¼ŒClient åªèƒ½ä¿æŒä¸€ä¸ªè¿æ¥', 'warning');
            showResult(false, 'âŒ æµ‹è¯•ç»“æœï¼šClient ä¸æ”¯æŒåŒæ—¶è¿æ¥å¤šä¸ª Transport');
          }
        } catch (error) {
          log(`âŒ æµ‹è¯•è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
          console.error('è¯¦ç»†é”™è¯¯:', error);
          showResult(false, `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
        }
      }

      // æ¸…ç©ºæ—¥å¿—
      function clearLog() {
        document.getElementById('log').innerHTML = '';
        document.getElementById('result').innerHTML = '';
      }

      // ç»‘å®šäº‹ä»¶
      document.getElementById('btnRunTest').addEventListener('click', runTest);
      document.getElementById('btnClearLog').addEventListener('click', clearLog);

      // é¡µé¢åŠ è½½æç¤º
      window.addEventListener('load', () => {
        log('ğŸ“‹ æµ‹è¯•å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"è¿è¡Œæµ‹è¯•"æŒ‰é’®å¼€å§‹', 'info');
      });
    </script>
  </body>
</html>
