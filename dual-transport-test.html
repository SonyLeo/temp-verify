<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>åŒ Transport éªŒè¯æµ‹è¯•</title>
    <script src="https://unpkg.com/@opentiny/next-sdk@0.1.10/dist/index.umd.js"></script>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #4caf50;
        padding-bottom: 10px;
      }
      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }
      .panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .panel h2 {
        margin-top: 0;
        color: #555;
        font-size: 18px;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px;
        transition: background 0.3s;
      }
      button:hover {
        background: #45a049;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .log {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin-top: 15px;
        max-height: 300px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }
      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid #4caf50;
        padding-left: 10px;
      }
      .log-entry.error {
        border-left-color: #f44336;
        color: #f44336;
      }
      .log-entry.success {
        border-left-color: #4caf50;
        color: #4caf50;
      }
      .log-entry.info {
        border-left-color: #2196f3;
        color: #2196f3;
      }
      .status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 10px;
      }
      .status.connected {
        background: #4caf50;
        color: white;
      }
      .status.disconnected {
        background: #f44336;
        color: white;
      }
      iframe {
        width: 100%;
        height: 200px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 10px;
      }
      .full-width {
        grid-column: 1 / -1;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ”¬ åŒ Transport è¿æ¥éªŒè¯æµ‹è¯•</h1>
    <p>éªŒè¯ä¸€ä¸ª MCP WebMcpClient èƒ½å¦åŒæ—¶è¿æ¥ MessageChannelServerTransport å’Œ createTransportPair</p>

    <div class="container">
      <!-- Server A: MessageChannel (iframe) -->
      <div class="panel">
        <h2>ğŸŒ Server A - MessageChannel (iframe)</h2>
        <div>çŠ¶æ€: <span class="status disconnected" id="statusA">æœªè¿æ¥</span></div>
        <button id="btnTestA">æµ‹è¯• Server A å·¥å…·</button>
        <div class="log" id="logA"></div>
        <iframe id="iframeServer"></iframe>
      </div>

      <!-- Server B: TransportPair (æœ¬åœ°) -->
      <div class="panel">
        <h2>ğŸ’» Server B - TransportPair (æœ¬åœ°)</h2>
        <div>çŠ¶æ€: <span class="status disconnected" id="statusB">æœªè¿æ¥</span></div>
        <button id="btnTestB">æµ‹è¯• Server B å·¥å…·</button>
        <div class="log" id="logB"></div>
      </div>

      <!-- ç»¼åˆæµ‹è¯• -->
      <div class="panel full-width">
        <h2>ğŸ¯ ç»¼åˆæµ‹è¯•</h2>
        <button id="btnTestBoth">åŒæ—¶è°ƒç”¨ä¸¤ä¸ª Server</button>
        <button id="btnTestConcurrent">å¹¶å‘è°ƒç”¨æµ‹è¯•</button>
        <button id="btnClearLogs">æ¸…ç©ºæ—¥å¿—</button>
        <div class="log" id="logMain"></div>
      </div>
    </div>

    <script type="module">
      import { MessageChannelClientTransport } from 'https://cdn.jsdelivr.net/npm/@opentiny/next@0.2.1/+esm';

      const { createMessageChannelPairTransport, WebMcpClient, WebMcpServer, z } = WebMCP;

      let clientA = null; // è¿æ¥åˆ° iframe Server
      let clientB = null; // è¿æ¥åˆ°æœ¬åœ° Server
      let serverB = null; // æœ¬åœ° Server å®ä¾‹

      // æ—¥å¿—å·¥å…·
      function log(containerId, message, type = 'info') {
        const container = document.getElementById(containerId);
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        container.appendChild(entry);
        container.scrollTop = container.scrollHeight;
        console.log(`[${containerId}]`, message);
      }

      function updateStatus(serverId, connected) {
        const statusEl = document.getElementById(`status${serverId}`);
        statusEl.className = `status ${connected ? 'connected' : 'disconnected'}`;
        statusEl.textContent = connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
      }

      // åˆå§‹åŒ– Server B (æœ¬åœ° TransportPair)
      async function initServerB() {
        try {
          log('logB', 'æ­£åœ¨åˆå§‹åŒ–æœ¬åœ° Server B...', 'info');

          // åˆ›å»ºä¸€å¯¹å¯äº’é€šçš„ Transport
          const [serverTransport, clientTransport] = createMessageChannelPairTransport();

          // åˆ›å»º Server B
          serverB = new WebMcpServer({
            name: 'local-server-b',
            version: '1.0.0'
          });

          // æ³¨å†Œå·¥å…·ï¼šè®¡ç®—å™¨
          serverB.registerTool(
            'calculate',
            {
              title: 'è®¡ç®—å™¨',
              description: 'æ‰§è¡ŒåŸºæœ¬æ•°å­¦è¿ç®—',
              inputSchema: {
                operation: z.enum(['add', 'subtract', 'multiply', 'divide']),
                a: z.number(),
                b: z.number()
              }
            },
            async ({ operation, a, b }) => {
              let result;
              switch (operation) {
                case 'add':
                  result = a + b;
                  break;
                case 'subtract':
                  result = a - b;
                  break;
                case 'multiply':
                  result = a * b;
                  break;
                case 'divide':
                  result = b !== 0 ? a / b : 'Error: Division by zero';
                  break;
              }
              log('logB', `è®¡ç®—: ${a} ${operation} ${b} = ${result}`, 'success');
              return {
                content: [{ type: 'text', text: `ç»“æœ: ${result}` }]
              };
            }
          );

          // è¿æ¥ Server
          await serverB.connect(serverTransport);
          log('logB', 'Server B å·²å¯åŠ¨', 'success');

          // åˆ›å»º WebMcpClient B
          const capabilities = { prompts: {}, resources: {}, tools: {}, logging: {} };
          clientB = new WebMcpClient({ name: 'test-client-b', version: '1.0.0' }, { capabilities });

          await clientB.connect(clientTransport);
          log('logB', 'WebMcpClient B å·²è¿æ¥åˆ° Server B', 'success');
          updateStatus('B', true);

          // éªŒè¯å·¥å…·åˆ—è¡¨
          const tools = await clientB.listTools();
          log('logB', `å‘ç° ${tools.tools.length} ä¸ªå·¥å…·: ${tools.tools.map((t) => t.name).join(', ')}`, 'info');
        } catch (error) {
          log('logB', `åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
          updateStatus('B', false);
        }
      }

      // åˆå§‹åŒ– Server A (iframe MessageChannel)
      async function initServerA() {
        try {
          log('logA', 'æ­£åœ¨åˆå§‹åŒ– iframe Server A...', 'info');

          // åˆ›å»º iframe å¹¶åŠ è½½ Server A
          const iframe = document.getElementById('iframeServer');
          iframe.src = 'dual-transport-server-a.html';

          // ç­‰å¾… iframe åŠ è½½å®Œæˆ
          await new Promise((resolve, reject) => {
            iframe.onload = resolve;
            iframe.onerror = reject;
            setTimeout(() => reject(new Error('iframe åŠ è½½è¶…æ—¶')), 5000);
          });

          log('logA', 'iframe å·²åŠ è½½', 'info');

          // ç­‰å¾… Server A å‡†å¤‡å°±ç»ª
          window.addEventListener('message', function handler(event) {
            console.log('æ”¶åˆ°æ¶ˆæ¯:', event.data);
            if (event.data.type === 'server-a-ready') {
              window.removeEventListener('message', handler);
            }
          });

          log('logA', 'Server A å·²å‡†å¤‡å°±ç»ª', 'success');

          // åˆ›å»º WebMcpClient A è¿æ¥åˆ° iframe
          // å…³é”®ï¼šç¬¬äºŒä¸ªå‚æ•°å¿…é¡»ä¼ å…¥ iframe.contentWindow
          const clientTransport = new MessageChannelClientTransport('server-a-endpoint', iframe.contentWindow);

          const capabilities = { prompts: {}, resources: {}, tools: {}, logging: {} };
          clientA = new WebMcpClient({ name: 'test-client-a', version: '1.0.0' }, { capabilities });

          await clientA.connect(clientTransport);
          log('logA', 'WebMcpClient A å·²è¿æ¥åˆ° Server A', 'success');
          updateStatus('A', true);

          // éªŒè¯å·¥å…·åˆ—è¡¨
          const tools = await clientA.listTools();
          log('logA', `å‘ç° ${tools.tools.length} ä¸ªå·¥å…·: ${tools.tools.map((t) => t.name).join(', ')}`, 'info');
        } catch (error) {
          log('logA', `åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
          updateStatus('A', false);
        }
      }

      // æµ‹è¯• Server A
      async function testServerA() {
        if (!clientA) {
          log('logA', 'WebMcpClient A æœªè¿æ¥', 'error');
          return;
        }

        try {
          log('logA', 'è°ƒç”¨å·¥å…·: generate-greeting', 'info');
          const result = await clientA.callTool({
            name: 'generate-greeting',
            arguments: { name: 'å¼ ä¸‰', language: 'zh' }
          });
          log('logA', `ç»“æœ: ${result.content[0].text}`, 'success');
        } catch (error) {
          log('logA', `è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
        }
      }

      // æµ‹è¯• Server B
      async function testServerB() {
        if (!clientB) {
          log('logB', 'WebMcpClient B æœªè¿æ¥', 'error');
          return;
        }

        try {
          log('logB', 'è°ƒç”¨å·¥å…·: calculate', 'info');
          const result = await clientB.callTool({
            name: 'calculate',
            arguments: { operation: 'multiply', a: 12, b: 8 }
          });
          log('logB', `ç»“æœ: ${result.content[0].text}`, 'success');
        } catch (error) {
          log('logB', `è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
        }
      }

      // åŒæ—¶æµ‹è¯•ä¸¤ä¸ª Server
      async function testBothServers() {
        log('logMain', '=== å¼€å§‹åŒæ—¶è°ƒç”¨ä¸¤ä¸ª Server ===', 'info');

        try {
          // è°ƒç”¨ Server A
          log('logMain', 'è°ƒç”¨ Server A: generate-greeting', 'info');
          const resultA = await clientA.callTool({
            name: 'generate-greeting',
            arguments: { name: 'æå››', language: 'en' }
          });
          log('logMain', `Server A ç»“æœ: ${resultA.content[0].text}`, 'success');

          // è°ƒç”¨ Server B
          log('logMain', 'è°ƒç”¨ Server B: calculate', 'info');
          const resultB = await clientB.callTool({
            name: 'calculate',
            arguments: { operation: 'add', a: 100, b: 200 }
          });
          log('logMain', `Server B ç»“æœ: ${resultB.content[0].text}`, 'success');

          log('logMain', 'âœ… ä¸¤ä¸ª Server éƒ½è°ƒç”¨æˆåŠŸï¼', 'success');
        } catch (error) {
          log('logMain', `è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
        }
      }

      // å¹¶å‘è°ƒç”¨æµ‹è¯•
      async function testConcurrent() {
        log('logMain', '=== å¼€å§‹å¹¶å‘è°ƒç”¨æµ‹è¯• ===', 'info');

        try {
          const promises = [
            clientA.callTool({
              name: 'generate-greeting',
              arguments: { name: 'ç‹äº”', language: 'zh' }
            }),
            clientB.callTool({
              name: 'calculate',
              arguments: { operation: 'divide', a: 100, b: 4 }
            }),
            clientA.callTool({
              name: 'generate-greeting',
              arguments: { name: 'Alice', language: 'en' }
            }),
            clientB.callTool({
              name: 'calculate',
              arguments: { operation: 'subtract', a: 50, b: 30 }
            })
          ];

          log('logMain', 'åŒæ—¶å‘èµ· 4 ä¸ªè¯·æ±‚...', 'info');
          const results = await Promise.all(promises);

          results.forEach((result, index) => {
            log('logMain', `è¯·æ±‚ ${index + 1} ç»“æœ: ${result.content[0].text}`, 'success');
          });

          log('logMain', 'âœ… å¹¶å‘è°ƒç”¨å…¨éƒ¨æˆåŠŸï¼', 'success');
        } catch (error) {
          log('logMain', `å¹¶å‘è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
        }
      }

      // æ¸…ç©ºæ—¥å¿—
      function clearLogs() {
        document.getElementById('logA').innerHTML = '';
        document.getElementById('logB').innerHTML = '';
        document.getElementById('logMain').innerHTML = '';
      }

      // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
      function setupEventListeners() {
        document.getElementById('btnTestA').addEventListener('click', testServerA);
        document.getElementById('btnTestB').addEventListener('click', testServerB);
        document.getElementById('btnTestBoth').addEventListener('click', testBothServers);
        document.getElementById('btnTestConcurrent').addEventListener('click', testConcurrent);
        document.getElementById('btnClearLogs').addEventListener('click', clearLogs);
      }

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.addEventListener('load', async () => {
        setupEventListeners();
        log('logMain', 'å¼€å§‹åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ...', 'info');
        await Promise.all([initServerB(), initServerA()]);
        log('logMain', 'âœ… æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼', 'success');
      });
    </script>
  </body>
</html>
